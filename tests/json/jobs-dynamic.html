---
layout: default
permalink: /tests/jobs-dynamic/
---
{%- assign markets_au = site.data.markets-au.contentlets -%}
{%- assign markets_ca = site.data.markets-ca.contentlets -%}
{%- assign markets_de = site.data.markets-de.contentlets -%}
{%- assign markets_fr = site.data.markets-fr.contentlets -%}
{%- assign markets_jp = site.data.markets-jp.contentlets -%}
{%- assign markets_nl = site.data.markets-nl.contentlets -%}
{%- assign markets_uk = site.data.markets-uk.contentlets -%}
{%- assign markets_us = site.data.markets-us.contentlets -%}

<style>
.hide { display: none; }
</style>

<form id="location-selector" action="{{page.permalink}}">
  <select name="m" id="m" onchange="this.form.submit();">
    <option value="">Select a location nearest you</option>
    <option value="remote">Remote</option>
    <optgroup label="Australia">
      {%- for market in markets_au -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="Canada">
      {%- for market in markets_ca -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="Europe">
      {%- for market in markets_uk -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
      {%- for market in markets_nl -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
      {%- for market in markets_fr -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="Japan">
      {%- for market in markets_jp -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="United States">
      {%- for market in markets_us -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
  </select>
</form>
<div id="messages">
  <div id="loading" class="loading">
    <p>Please wait while we find you some jobs…</p>
  </div>
  <div id="error-results" class="hide">
    <h4>Ooops!</h4>
    <p>We were unable to find jobs for this location. Please try another location, or come back later to check for freshly posted jobs.</p>
  </div>
  <div id="error-server" class="hide">
    <h4>Ooops!</h4>
    <p>We were unable to retrieve jobs due to a server error. Please try again later.</p>
  </div>
  <div id="error-connection" class="hide">
    <h4>Ooops!</h4>
    <p>The hamsters running this wheel were conspicuously absent. As a result, your request fell on deaf ears. Please try again later.</p>
  </div>
</div>
<div id="jobs"></div>
<script>
// Polyfill for Array.prototype.filter() via @https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter
if (!Array.prototype.filter){
  Array.prototype.filter = function(func, thisArg) {
    'use strict';
    if ( ! ((typeof func === 'Function' || typeof func === 'function') && this) )
        throw new TypeError();

    var len = this.length >>> 0,
        res = new Array(len), // preallocate array
        t = this, c = 0, i = -1;

    var kValue;
    if (thisArg === undefined){
      while (++i !== len){
        // checks to see if the key was set
        if (i in this){
          kValue = t[i]; // in case t is changed in callback
          if (func(t[i], i, t)){
            res[c++] = kValue;
          }
        }
      }
    }
    else{
      while (++i !== len){
        // checks to see if the key was set
        if (i in this){
          kValue = t[i];
          if (func.call(thisArg, t[i], i, t)){
            res[c++] = kValue;
          }
        }
      }
    }

    res.length = c; // shrink down array to proper size
    return res;
  };
}

Array.prototype.shuffle = function () {
  let input = this;

  for (let i = input.length - 1; i >= 0; i--) {

    let randomIndex = Math.floor(Math.random() * (i + 1));
    let itemAtIndex = input[randomIndex];

    input[randomIndex] = input[i];
    input[i] = itemAtIndex;
  }
  return input;
}

// Get URL Parameter
function getUrlParameter(name) {
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  var results = regex.exec(location.search);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};

var endpoint = 'https://stag-assets.aquent.com/apps/gym/jobs.json?limit=1500';

// For testing/debugging
if (window.location.host == 'localhost:4000') {
  endpoint = '/jobs.json';
}

// Add exception for `remote` option in the markets dropdown
var market = getUrlParameter('m') == 'remote' ? undefined : getUrlParameter('m');

// If we have a market populated on page load, update the dropdown
if (typeof market !== 'undefined' && market !== null && market.length) {
  updateDropdown(market);
}

// Update dropdown to the selected option
function updateDropdown(m) {
  document.querySelector('#m [value="' + m + '"]').selected = true;
}

var data;

const jobsContainer = document.getElementById('jobs');
const msgContainer = document.getElementById('messages');

function showMsg(id) {
  // firstly, hide any visible messaging
  msgContainer.querySelectorAll('div').forEach(el => {
    el.classList.add('hide');
  });

  // show the element we want!
  document.getElementById(id).classList.remove('hide');
}

// If we have jobs stored locally already in the browser session...
if (window.sessionStorage && sessionStorage.getItem('jobs')) {
  data = sessionStorage.getItem('jobs');
  console.log('data from sessionStorage');
  
  processData(data);
} else {
  // Otherwise, get the jobs from the endpoint

  var request = new XMLHttpRequest();

  request.open('GET', endpoint, true);

  request.onload = function() {

    if (this.status >= 200 && this.status < 400) {
      if (typeof this.response !== "undefined" && this.response !== null) {
        var response = this.response;

        if (window.sessionStorage) {
          // TODO: add an expiration?
          // const now = new Date();
          // response["timestamp"]= now.getTime();

          sessionStorage.setItem('jobs', response);
        } else {
          console.warn('No browser support for sessionStorage!');
        }

        console.log('fetching data from endpoint: ', endpoint);

        processData(response);

      } else {
        // No jobs in market (or there was no data)! Show the appropriate message.
        showMsg('error-results');
      }
    } else {
      // We reached our target server, but it returned an error
      showMsg('error-server');
    }
  };

  request.onerror = function() {
    // There was a connection error of some sort
    showMsg('error-connection');
  };

  request.send();
}

// Process our JSON data
function processData(data) {
  data = JSON.parse(data);

  var items = data.items;

  // #* Off-site preference key
  // 0 = Unknown
  // 1 = On-Site
  // 2 = Off-Site
  // 3 = Either
  // 4 = Partial on-site
  // *#

  // Filter the jobs by market if we have a market param
  if (typeof market !== 'undefined' && market !== null && market.length) {
    items = items.filter(item => item.market === market);
    console.log('showing jobs for a specific market');
  } else {
    items = items.filter(item => parseInt(item.remote) > 1);
    updateDropdown('remote');
    console.log('showing remote options…');
  }

  // Randomize the results we show…
  items = items.shuffle();

  // How many results do we have?
  var numResults = items.length;

  if (numResults > 0) {
    // hide our loading message
    document.getElementById('loading').classList.add('hide');

    // open our list
    jobsContainer.innerHTML += '<ul>';

    // Set iteration limits
    var limit = 10;

    if (numResults < limit) {
      limit = numResults;
    }

    // Generate job item
    for (var i = 0; i < limit; i++) {
      el = items[i];
      jobsContainer.innerHTML += '<li><a href="' + decodeURI(el.url) + '?utm_campaign=gymnasium" title="' + el.title + '">' + el.title + '</a></li>';
    }

    // close our list
    jobsContainer.innerHTML += '</ul>';
  } else {
    // No jobs in market! Show the appropriate message.
    showMsg('error-results');
  }
}

</script>
