---
layout: default
permalink: /tests/job-dynamic/
---
{%- assign markets_au = site.data.markets-au.contentlets -%}
{%- assign markets_ca = site.data.markets-ca.contentlets -%}
{%- assign markets_de = site.data.markets-de.contentlets -%}
{%- assign markets_fr = site.data.markets-fr.contentlets -%}
{%- assign markets_jp = site.data.markets-jp.contentlets -%}
{%- assign markets_nl = site.data.markets-nl.contentlets -%}
{%- assign markets_uk = site.data.markets-uk.contentlets -%}
{%- assign markets_us = site.data.markets-us.contentlets -%}
<form id="location-selector" action="{{page.permalink}}">
  <select name="m" id="m" onchange="this.form.submit();">
    <option value="">Select</option>
    <optgroup label="Australia">
      {%- for market in markets_au -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="Canada">
      {%- for market in markets_ca -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="Europe">
      {%- for market in markets_uk -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
      {%- for market in markets_nl -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
      {%- for market in markets_fr -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="Japan">
      {%- for market in markets_jp -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
    <optgroup label="United States">
      {%- for market in markets_us -%}
        <option value="{{market.marketId}}">{{market.name}}</option>
      {%- endfor -%}
    </optgroup>
  </select>
</form>
<div id="jobs"></div>
<script>
// Polyfill for Array.prototype.filter() via @https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter
if (!Array.prototype.filter){
  Array.prototype.filter = function(func, thisArg) {
    'use strict';
    if ( ! ((typeof func === 'Function' || typeof func === 'function') && this) )
        throw new TypeError();

    var len = this.length >>> 0,
        res = new Array(len), // preallocate array
        t = this, c = 0, i = -1;

    var kValue;
    if (thisArg === undefined){
      while (++i !== len){
        // checks to see if the key was set
        if (i in this){
          kValue = t[i]; // in case t is changed in callback
          if (func(t[i], i, t)){
            res[c++] = kValue;
          }
        }
      }
    }
    else{
      while (++i !== len){
        // checks to see if the key was set
        if (i in this){
          kValue = t[i];
          if (func.call(thisArg, t[i], i, t)){
            res[c++] = kValue;
          }
        }
      }
    }

    res.length = c; // shrink down array to proper size
    return res;
  };
}

// Get URL Parameter
function getUrlParameter(name) {
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  var results = regex.exec(location.search);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};
var endpoint = 'https://stag-assets.aquent.com/apps/gym/jobs.json';

// For testing/debugging
if (window.location.host == 'localhost:4000') {
  endpoint = '/jobs.json';
}

var market = getUrlParameter('m');

if (market.length) {
  endpoint += '?m=' + market;
}

console.log('fetching: ', endpoint);

var request = new XMLHttpRequest();
var data;
var jobsContainer = document.getElementById('jobs');
request.open('GET', endpoint, true);

request.onload = function() {
  if (this.status >= 200 && this.status < 400) {
    // Success!
    data = JSON.parse(this.response);
    // console.log(data);

    if (typeof data !== "undefined" && data !== null) {
      var items = data.items;
      var numResults = data.items.length;

      if (numResults > 0) {
        // open our UL
        jobsContainer.innerHTML += '<ul>';

        var limit = 10;

        if (numResults < limit) {
          limit = numResults;
        }

        // Show 10 jobs
        for(var i = 0; i < limit; i++) {
          el = items[i];
          jobsContainer.innerHTML += '<li><a href="' + decodeURI(el.url) + '" title="' + el.title + '">' + el.title + '</a></li>';
        }

        // close our list
        jobsContainer.innerHTML += '</ul>';
      } else {
        // No jobs in market!
        jobsContainer.innerHTML = '<h4>Ooops!</h4><p>We were unable to find jobs for this location. Please try another location, or come back later to check for freshly posted jobs.</p>';
      }
    } else {
      // No jobs in market!
      jobsContainer.innerHTML = '<h4>Ooops!</h4><p>We were unable to find jobs for this location. Please try another location, or come back later to check for freshly posted jobs.</p>';
    }
  } else {
    // We reached our target server, but it returned an error
    jobsContainer.innerHTML = '<h4>Ooops!</h4><p>We were unable to retrieve jobs for the requested location. Please try again later.</p>';
  }
};

request.onerror = function() {
  // There was a connection error of some sort
  jobsContainer.innerHTML = '<h4>Ooops!</h4><p>The hamsters running this wheel were conspicuously absent. As a result, your request fell on deaf ears. Please try again later.</p>';
};

request.send();

</script>
